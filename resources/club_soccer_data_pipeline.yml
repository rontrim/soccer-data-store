resources:
  jobs:
    Club_Soccer_Data_Processing:
      name: Club Soccer Data Processing${var.job_suffix}
      
      email_notifications:
        on_success:
          - rhetrim@gmail.com
        on_failure:
          - rhetrim@gmail.com
      
      schedule:
        quartz_cron_expression: 30 0 21 ? * Tue
        timezone_id: America/New_York
        pause_status: UNPAUSED
      
      tasks:
        # ----------------------------------------------------------------
        # Task 1: Check for new data (Python Script)
        # ----------------------------------------------------------------
        - task_key: New_matches_check
          # job_cluster_key: club_soccer_ingestion  <-- Removed to enable Serverless Compute
          spark_python_task:
            # UPDATED: Relative path to the file in your repo
            python_file: ../club-soccer-data/bronze-layer/recent_matches_check.py
            # Note: Since Serverless doesn't support spark_conf, if your script needs the path,
            # you should pass it as a parameter here instead:
            # parameters:
            #   - "/mnt/soccerdatastore/extract"
          environment_key: Default

        # ----------------------------------------------------------------
        # Task 2: Decision Logic (If new data > 0)
        # ----------------------------------------------------------------
        - task_key: New_matches_confirmation
          depends_on:
            - task_key: New_matches_check
          condition_task:
            op: GREATER_THAN
            left: "{{tasks.New_matches_check.values.row_count}}"
            right: "0"

        # ----------------------------------------------------------------
        # Task 3: Ingest (Bronze Pipeline)
        # ----------------------------------------------------------------
        - task_key: ingest_club_soccer_data
          depends_on:
            - task_key: New_matches_confirmation
              outcome: "true"
          pipeline_task:
            # UPDATED: dynamic reference to your Bronze pipeline resource
            pipeline_id: ${resources.pipelines.soccer_bronze_pipeline.id}
            full_refresh: false

        # ----------------------------------------------------------------
        # Task 4: Clean (Silver Pipeline)
        # ----------------------------------------------------------------
        - task_key: clean_club_soccer_data
          depends_on:
            - task_key: ingest_club_soccer_data
          pipeline_task:
            # UPDATED: dynamic reference to your Silver pipeline resource
            pipeline_id: ${resources.pipelines.soccer_silver_pipeline.id}
            full_refresh: false

        # ----------------------------------------------------------------
        # Task 5: Analyze (Gold Pipeline)
        # ----------------------------------------------------------------
        - task_key: analyze_club_soccer_data
          depends_on:
            - task_key: clean_club_soccer_data
          pipeline_task:
            # UPDATED: dynamic reference to your Gold pipeline resource
            pipeline_id: ${resources.pipelines.soccer_gold_pipeline.id}
            full_refresh: false

      # ----------------------------------------------------------------
      # Cluster Definition
      # ----------------------------------------------------------------
      # job_clusters section removed entirely to default to Serverless

      environments:
        - environment_key: Default
          spec:
            environment_version: "4"